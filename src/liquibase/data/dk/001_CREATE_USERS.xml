<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="1" author="ipo" runOnChange="true">

        <comment>Create ICs/Users</comment>

        <sql>
            declare @adminUserRights int = 14 -- admin/claims handler/supply manager
            declare @chUserRights int = 10 -- claims handler/supply manager
            declare @scalepointCompany bigint = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'SCALEPOINT')

            update [User] set UserName = concat(UserName,'-old-',UserID) where Email = 'ecc_auto@scalepoint.com' and UserName like 'autotest-%'

            EXEC autotests_create_user 'autotest-system-scalepoint', @scalepointCompany, @adminUserRights
            EXEC autotests_create_user 'autotest-user-sp',           @scalepointCompany, @adminUserRights

            declare @masterTemplateName varchar(50) = 'mastr'
            declare @serviceAgreementName varchar(50) = 'AutoTest Agreement'
            declare @serviceAgreementNameForWizard varchar(50) = 'AutoTest Agreement For Wizard'

            -- there are no companies/fts in the range 50-60 across all the countries, so lets grab those ids
            declare @companyId int = 51
            EXEC autotests_create_ic @companyId, 'Future-1'
            EXEC autotests_create_user 'autotest-user-future1', @companyId, @adminUserRights
            EXEC autotests_create_choice_reasons @companyId
            EXEC autotests_create_service_agreements @companyId, @masterTemplateName, @serviceAgreementName, @serviceAgreementNameForWizard

            SET @companyId = 52
            EXEC autotests_create_ic @companyId, 'Future-2'
            EXEC autotests_create_user 'autotest-user-future2', @companyId, @adminUserRights
            EXEC autotests_create_choice_reasons @companyId
            EXEC autotests_create_service_agreements @companyId, @masterTemplateName, @serviceAgreementName, @serviceAgreementNameForWizard

            SET @companyId = 53
            EXEC autotests_create_ic @companyId, 'Future-3'
            EXEC autotests_create_user 'autotest-user-future3', @companyId, @adminUserRights
            EXEC autotests_create_choice_reasons @companyId
            EXEC autotests_create_service_agreements @companyId, @masterTemplateName, @serviceAgreementName, @serviceAgreementNameForWizard

            SET @companyId = 54
            EXEC autotests_create_ic @companyId, 'Future-4'
            EXEC autotests_create_user 'autotest-user-future4', @companyId, @adminUserRights
            EXEC autotests_create_choice_reasons @companyId
            EXEC autotests_create_service_agreements @companyId, @masterTemplateName, @serviceAgreementName, @serviceAgreementNameForWizard

            SET @companyId = 55
            EXEC autotests_create_ic @companyId, 'Future-5'
            EXEC autotests_create_user 'autotest-user-future5', @companyId, @adminUserRights
            EXEC autotests_create_choice_reasons @companyId
            EXEC autotests_create_service_agreements @companyId, @masterTemplateName, @serviceAgreementName, @serviceAgreementNameForWizard

            declare @lb_id int = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'LB')
            EXEC autotests_create_user 'autotest-user-lb', @lb_id, @chUserRights

            declare @bauta_id int = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'BAUTA')
            EXEC autotests_create_user 'autotest-user-bauta', @bauta_id, @chUserRights

            declare @tryg_id int = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'TRYGFORSIKRING')
            EXEC autotests_create_user 'autotest-user-trygfors', @tryg_id, @chUserRights
            EXEC autotests_create_redrule_tryg

            declare @alka_id int = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'ALKA')
            EXEC autotests_create_user 'autotest-user-alka', @alka_id, @chUserRights
        </sql>

        <sql>
            -- switch off password validation
            UPDATE [FUNCTEMPLATE] SET [ftUserPasswordValidationStrategy] = 0

            -- switch off password expiration
            UPDATE [FUNCTEMPLATE] SET ftfunctionflags5 = ftfunctionflags5 &amp; ~1

            -- switch off password change on first login
            UPDATE [FUNCTEMPLATE] SET ftfunctionflags5 = ftfunctionflags5 &amp; ~2

            -- enable new settlement item dialog
            UPDATE [FUNCTEMPLATE] SET [ftEnableNewSettlementItemDialog] = 1

            -- disable RnV2
            UPDATE [FUNCTEMPLATE] SET [ftAutoApprovalFlag] = 0

        </sql>

        <rollback/>
    </changeSet>
</databaseChangeLog>