<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="1" author="ipo" runOnChange="true">

        <comment>Create ICs/Users</comment>

        <sql>
            declare @adminUserRights int = 14 -- admin/claims handler/supply manager
            declare @chUserRights int = 10 -- claims handler/supply manager
            declare @scalepointCompany bigint = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'SCALEPOINT')

            declare @SupplierId int
            EXEC autotests_create_supplier @SUNAME='Autotest-Supplier-VA-Tests', @insCompanyId = @scalepointCompany, @PostalCode = '4321', @SupplierId = @SupplierId OUTPUT

            update [User] set UserName = concat(UserName,'-old-',UserID) where Email = 'ecc_auto@scalepoint.com' and UserName like 'autotest-%'

            EXEC autotests_create_user @scalepointCompany, 'autotest-system', @adminUserRights
            EXEC autotests_create_user @scalepointCompany, 'autotest-sp', @adminUserRights

            -- there are no companies/fts in the range 50-60 across all the countries, so lets grab those ids
            exec autotests_prepare_future_company 50, @adminUserRights
            exec autotests_prepare_future_company 51, @adminUserRights
            exec autotests_prepare_future_company 52, @adminUserRights
            exec autotests_prepare_future_company 53, @adminUserRights
            exec autotests_prepare_future_company 54, @adminUserRights
            exec autotests_prepare_future_company 55, @adminUserRights
            exec autotests_prepare_future_company 56, @adminUserRights
            exec autotests_prepare_future_company 57, @adminUserRights
            exec autotests_prepare_future_company 58, @adminUserRights
            exec autotests_prepare_future_company 59, @adminUserRights
            exec autotests_prepare_future_company 60, @adminUserRights

            declare @lb_id int = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'LB')
            EXEC autotests_create_user @lb_id, 'autotest-lb', @chUserRights

            declare @bauta_id int = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'BAUTA')
            EXEC autotests_create_user @bauta_id, 'autotest-bauta', @chUserRights

            declare @tryg_id int = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'TRYGFORSIKRING')
            EXEC autotests_create_user @tryg_id, 'autotest-trygfors', @chUserRights
            EXEC autotests_create_redrule 'Autotest-MusikRule', 'TRYGFORSIKRING', 'Øvrige', 'Musik, Film &amp; Spil', '36-37', 36, 37, 10, 20, 0.2, 0, 1

            declare @tryghold_id int = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'TRYGHOLDING')
            EXEC autotests_create_user @tryghold_id, 'autotest-trygholding', @chUserRights
            EXEC autotests_create_redrule 'Autotest-MusikRule', 'TRYGFORSIKRING', 'Øvrige', 'Musik, Film &amp; Spil', '36-37', 36, 37, 10, 20, 0.2, 0, 1

            declare @alka_id int = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'ALKA')
            EXEC autotests_create_user @alka_id, 'autotest-alka', @chUserRights

            declare @topdanmark_id int = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'TOPDANMARK')
            EXEC autotests_create_user @topdanmark_id, 'autotest-topdanmark', @chUserRights
        </sql>

        <sql>
            -- switch off password validation
            UPDATE [FUNCTEMPLATE] SET [ftUserPasswordValidationStrategy] = 0

            -- switch off password expiration
            UPDATE [FUNCTEMPLATE] SET ftfunctionflags5 = ftfunctionflags5 &amp; ~1

            -- switch off password change on first login
            UPDATE [FUNCTEMPLATE] SET ftfunctionflags5 = ftfunctionflags5 &amp; ~2

            -- disable RnV2
            UPDATE [FUNCTEMPLATE] SET [ftAutoApprovalFlag] = 0

        </sql>

        <sql>
            --enable eventAPI and UnifiedPayments for Topdanmark
            declare @topdanmark_id int = (SELECT ICRFNBR FROM [dbo].[INSCOMP] WHERE CompanyCode = 'Topdanmark')
            UPDATE [dbo].[INSCOMP]
            SET eventAPIEnabled=1, eventsConfiguration='{"validationEngineEventsEnabled":true,"selfServiceEventsEnabled":true,"unifiedPaymentEventsEnabled":true,"reopenEventsEnabled":true}'
            WHERE ICRFNBR=@topdanmark_id
        </sql>

        <rollback/>
    </changeSet>
</databaseChangeLog>